include sites-enabled/anonymized.net.d/redirect.conf;

server {
    listen          80;
    listen          [::]:80;
    server_name     ctf.anonymized.net localhost django.localhost;

    error_log sites-enabled/anonymized.net.d/logs/http_error.log debug;

    if ($badagent) {
        return 403;
    }

    include sites-enabled/anonymized.net.d/certbot.conf;

    if ($is_local = 0) {
        return 301 https://$host$request_uri;
    }

    location ~* ^/(\.well-known/.*)|(.+\.(txt))$ {
        add_header  X-Robots-Tag "noindex, nosnippet";
        add_header Cache-Control "public, must-revalidate, noarchive";
        expires             60s;

        access_log          sites-enabled/anonymized.net.d/logs/static-root.log main_log buffer=512k flush=1m;
        root                /djangosite_dynamic/static/;
        
        include sites-enabled/anonymized.net.d/security.conf;
        include sites-enabled/anonymized.net.d/gzip.conf;
    }

    location /static/ {
        add_header Cache-Control "public, must-revalidate, noarchive";
        expires             7d;

        access_log          sites-enabled/anonymized.net.d/logs/static.log main_log buffer=512k flush=1m;
        alias               /djangosite_dynamic/static/;
        
        include sites-enabled/anonymized.net.d/security.conf;
        include sites-enabled/anonymized.net.d/gzip.conf;
    }

    location /media/ {
        add_header Cache-Control "private, no-store, must-revalidate, noarchive";
        expires             7d;

        access_log          sites-enabled/anonymized.net.d/logs/media.log main_log buffer=512k flush=1m;
        alias               /djangosite_data/media/;
        
        include sites-enabled/anonymized.net.d/security.conf;
        include sites-enabled/anonymized.net.d/gzip.conf;
    }

    location / {
        add_header Cache-Control "max-age=0, no-cache, no-store, must-revalidate, private";
        expires             0s;

        access_log  sites-enabled/anonymized.net.d/logs/django.log main_log buffer=512k flush=1m;

        include             sites-enabled/anonymized.net.d/uwsgi_params;
        uwsgi_pass          django:8080;
        
        include sites-enabled/anonymized.net.d/security.conf;
    }
}

server {
    listen          443 ssl;
    listen          [::]:443 ssl;
    server_name     ctf.anonymized.net localhost django.localhost;
    include sites-enabled/anonymized.net.d/ssl*.conf;

    error_log sites-enabled/anonymized.net.d/logs/https_error.log debug;

    if ($badagent) {
        return 403;
    }

    include sites-enabled/anonymized.net.d/certbot.conf;

    location ~* ^/(\.well-known/.*)|(.+\.(txt))$ {
        add_header  X-Robots-Tag "noindex, nosnippet";
        add_header Cache-Control "public, must-revalidate, noarchive";
        expires             60s;
        access_log          sites-enabled/anonymized.net.d/logs/static-root.log main_log buffer=512k flush=1m;
        root                /djangosite_dynamic/static/;
        
        include sites-enabled/anonymized.net.d/security.conf;
        include sites-enabled/anonymized.net.d/gzip.conf;
    }

    location /static/ {
        add_header Cache-Control "public, must-revalidate, noarchive";
        expires             7d;
        access_log          sites-enabled/anonymized.net.d/logs/static.log main_log buffer=512k flush=1m;
        alias               /djangosite_dynamic/static/;
        
        include sites-enabled/anonymized.net.d/security.conf;
        include sites-enabled/anonymized.net.d/gzip.conf;
    }

    location /media/ {
        add_header Cache-Control "private, no-store, must-revalidate, noarchive";
        expires             7d;
        access_log          sites-enabled/anonymized.net.d/logs/media.log main_log buffer=512k flush=1m;
        alias               /djangosite_data/media/;
        
        include sites-enabled/anonymized.net.d/security.conf;
        include sites-enabled/anonymized.net.d/gzip.conf;
    }

    location / {
        add_header Cache-Control "max-age=0, no-cache, no-store, must-revalidate, private";
        expires             0s;

        access_log  sites-enabled/anonymized.net.d/logs/django.log main_log buffer=512k flush=1m;

        include             sites-enabled/anonymized.net.d/uwsgi_params;
        uwsgi_pass          django:8080;

        include sites-enabled/anonymized.net.d/security.conf;
    }
}

include sites-enabled/anonymized.net.d/umami.conf;
include sites-enabled/anonymized.net.d/pgadmin.conf;
